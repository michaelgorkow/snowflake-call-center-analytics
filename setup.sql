-- Create stages for file storage
CREATE STAGE IF NOT EXISTS AUDIO_FILES
    ENCRYPTION = (TYPE = 'SNOWFLAKE_SSE')
    DIRECTORY = ( ENABLE = true )
    COMMENT = 'Used to store recordings';

CREATE STAGE IF NOT EXISTS UDF
    ENCRYPTION = (TYPE = 'SNOWFLAKE_SSE')
    DIRECTORY = (ENABLE = TRUE)
    COMMENT = 'Used to create UDFs';


-- Copy audio files into the stage
COPY FILES
  INTO @AUDIO_FILES
  FROM @CALL_CENTER_DEMO_DB.PUBLIC.GITHUB_REPO_CALL_CENTER_DEMO/branches/main/audio_files
  PATTERN='.*[.]mp3';
ALTER STAGE AUDIO_FILES REFRESH;

-- Create the streamlit app
CREATE STREAMLIT CALL_CENTER_ANALYTICS_DEMO_APP
  FROM @CALL_CENTER_DEMO_DB.PUBLIC.GITHUB_REPO_CALL_CENTER_DEMO/branches/main/streamlit_app
  MAIN_FILE = 'call_center_app.py'
  QUERY_WAREHOUSE = AI_WH;


-- Create the demo notebook
CREATE OR REPLACE NOTEBOOK CALL_CENTER_ANALYTICS_DEMO_NOTEBOOK
    FROM '@CALL_CENTER_DEMO_DB.PUBLIC.GITHUB_REPO_CALL_CENTER_DEMO/branches/main/' 
        MAIN_FILE = 'call_center_demo.ipynb' 
        QUERY_WAREHOUSE = AI_WH;
ALTER NOTEBOOK CALL_CENTER_ANALYTICS_DEMO_NOTEBOOK ADD LIVE VERSION FROM LAST;

-- Execute the notebook to setup data
EXECUTE NOTEBOOK CALL_CENTER_ANALYTICS_DEMO_NOTEBOOK();

-- Create Semantic View
create or replace semantic view CALL_CENTER_DEMO_DB.PUBLIC.CALL_CENTER_MODEL
	tables (
		ANALYZED_TRANSCRIPTIONS_APP with synonyms=('Transcribed Calls','Analyzed Conversations','Call Transcripts','Conversation Insights','Transcription Analysis','Call Recordings Analysis','Audio Transcriptions','Conversation Data','Call Data Analysis','Transcribed Audio') comment='This table stores analyzed transcription data from customer service calls, including call details, customer information, call intent, issue, resolution, and sentiment analysis, providing insights into customer interactions and call outcomes.'
	)
	facts (
		PUBLIC ANALYZED_TRANSCRIPTIONS_APP.TRANSCRIPTION_DURATION_SECONDS as TRANSCRIPTION_DURATION_SECONDS with synonyms=('call_length','conversation_time','seconds_transcribed.') comment='The total duration of the call in seconds.'
	)
	dimensions (
		PUBLIC ANALYZED_TRANSCRIPTIONS_APP.AUDIOFILE_RELATIVE_PATH as AUDIOFILE_RELATIVE_PATH with synonyms=('audio_file_location','relative_audio_path','audio_path','file_location','audio_file_directory','path_to_audio_file','audio_file_url') comment='The path to the audio file relative to the root directory, including the date of recording and the unique filename.',
		PUBLIC ANALYZED_TRANSCRIPTIONS_APP.AUDIO_FILE as AUDIO_FILE with synonyms=('audio_recording','sound_file','audio_clip','audio_data','sound_clip','audio_content','recorded_audio','audio_sample') comment='The name of the audio file that was analyzed for transcription.',
		PUBLIC ANALYZED_TRANSCRIPTIONS_APP.CALL_INTENT as CALL_INTENT with synonyms=('reason_for_call','call_purpose','call_reason','intent_of_call','purpose_of_contact','call_category') comment='The reason or purpose behind a customer''s call to the insurance company, such as disputing a claim, requesting a policy change, or seeking clarification on a claim.',
		PUBLIC ANALYZED_TRANSCRIPTIONS_APP.CALL_TO_ACTION as CALL_TO_ACTION with synonyms=('action_required','next_action','recommended_step','suggested_course','course_of_action','action_item','follow_up_action','required_action','action_needed') comment='The type of action requested or taken by the customer during the call, such as filing a claim, requesting a repair, or forwarding bills.',
		PUBLIC ANALYZED_TRANSCRIPTIONS_APP.CLAIM_NUMBER as CLAIM_NUMBER with synonyms=('claim_id','policy_claim_number','insurance_claim_number','claim_reference_number','claim_identifier') comment='Unique identifier assigned to a claim, used to track and reference the claim throughout the claims process.',
		PUBLIC ANALYZED_TRANSCRIPTIONS_APP.CONVERSATION_SENTIMENT as CONVERSATION_SENTIMENT with synonyms=('tone','emotional_tone','conversation_tone','sentiment_score','emotional_state','conversation_emotion','attitude','emotional_response') comment='The sentiment of the conversation, indicating whether the overall tone of the conversation was Positive or Negative.',
		PUBLIC ANALYZED_TRANSCRIPTIONS_APP.CONVERSATION_SUMMARY as CONVERSATION_SUMMARY with synonyms=('conversation_overview','call_summary','discussion_summary','conversation_recap','summary_of_conversation','conversation_synopsis') comment='A summary of customer conversations with insurance representatives, detailing the issues discussed, resolutions provided, and actions taken to address customer concerns and resolve claims.',
		PUBLIC ANALYZED_TRANSCRIPTIONS_APP.CUSTOMER as CUSTOMER with synonyms=('client','patron','buyer','consumer','purchaser','account_holder','subscriber','user','policyholder') comment='The name of the customer who made the call or interaction being transcribed.',
		PUBLIC ANALYZED_TRANSCRIPTIONS_APP.DATE as DATE with synonyms=('call_date') comment='Date of the call.',
		PUBLIC ANALYZED_TRANSCRIPTIONS_APP.FIRST_CALL_RESOLUTION as FIRST_CALL_RESOLUTION with synonyms=('first_time_fix','one_call_resolution','issue_resolved_on_first_call','first_contact_resolution','resolved_on_initial_call','one_and_done','first_call_success','initial_call_resolution') comment='Indicates whether the customer''s issue was resolved during the initial call, eliminating the need for additional follow-up calls.',
		PUBLIC ANALYZED_TRANSCRIPTIONS_APP.ISSUE as ISSUE with synonyms=('problem','concern','complaint','matter','topic','subject','grievance','dispute') comment='The ISSUE column captures the specific problems or concerns that customers have experienced with the company''s services, such as delays, communication breakdowns, or difficulties with the claims process.',
		PUBLIC ANALYZED_TRANSCRIPTIONS_APP.MODE_OF_UPDATE as MODE_OF_UPDATE with synonyms=('update_method','update_type','update_mode_type','change_method','modification_mode','revision_type','edit_mode','update_category') comment='The method by which the transcription was updated or confirmed, such as via email, written correspondence, or phone call.',
		PUBLIC ANALYZED_TRANSCRIPTIONS_APP.NEXT_STEPS as NEXT_STEPS with synonyms=('action_items','follow_up_tasks','future_actions','subsequent_steps','to_do_list','further_actions','recommended_actions','steps_to_take','tasks_ahead') comment='The NEXT_STEPS column captures the specific actions or tasks that need to be taken next in the process of resolving a customer''s issue or claim, as determined by the customer service representative or analyst.',
		PUBLIC ANALYZED_TRANSCRIPTIONS_APP.POLICY_NUMBER as POLICY_NUMBER with synonyms=('policy_id','policy_code','insurance_number','policy_reference','contract_number','account_number','customer_policy_id','policy_identifier') comment='Unique identifier for a specific insurance policy.',
		PUBLIC ANALYZED_TRANSCRIPTIONS_APP.PURPOSE_OF_CALL as PURPOSE_OF_CALL with synonyms=('reason_for_call','call_reason','call_purpose','intent_of_call','call_objective','objective_of_call','call_description','call_category') comment='The purpose or reason why the customer initiated the call.',
		PUBLIC ANALYZED_TRANSCRIPTIONS_APP.REPRESENTATIVE as REPRESENTATIVE with synonyms=('agent','customer_service_rep','customer_support_agent','representative_name','rep','account_manager','customer_representative','support_agent','customer_service_agent','account_representative') comment='The name of the sales representative who handled the customer interaction.',
		PUBLIC ANALYZED_TRANSCRIPTIONS_APP.RESOLUTION as RESOLUTION with synonyms=('solution','outcome','result','conclusion','settlement','answer','fix','remedy','resolve','final_result','disposition') comment='The RESOLUTION column captures the outcome or solution provided to the customer''s issue or claim, describing the specific actions taken to resolve the problem, such as payment, documentation, or repair authorization.',
		PUBLIC ANALYZED_TRANSCRIPTIONS_APP.RESPONSE_MODE as RESPONSE_MODE with synonyms=('response_type','reply_mode','communication_method','interaction_mode','answer_format','feedback_channel') comment='The method by which the customer prefers to receive a response from the company, such as via check in the mail, a phone call, or an immediate response.'
	)
	metrics (
		PUBLIC ANALYZED_TRANSCRIPTIONS_APP.AVERAGE_CALL_DURATION as AVG(TRANSCRIPTION_DURATION_SECONDS)/60 with synonyms=('AVG DURATION','average call time') comment='Average duration of calls in minutes',
		PUBLIC ANALYZED_TRANSCRIPTIONS_APP.FIRST_CALL_RESOLUTION_RATE as (SUM(CASE WHEN FIRST_CALL_RESOLUTION = 'Yes' THEN 1 ELSE 0 END) * 100.0 / COUNT(*)) with synonyms=('FCR rate','resolution rate','success rate') comment='Percentage of calls resolved on first contact',
		PUBLIC ANALYZED_TRANSCRIPTIONS_APP.TOTAL_CALLS as count(*) with synonyms=('call count','number of calls','call volume') comment='Total number of calls',
		PUBLIC ANALYZED_TRANSCRIPTIONS_APP.TOTAL_CALL_TIME as SUM(TRANSCRIPTION_DURATION_SECONDS)/60 with synonyms=('total duration','total call time','cumulative time') comment='Total time spent on all calls in minutes'
	)
	with extension (CA='{"tables":[{"name":"ANALYZED_TRANSCRIPTIONS_APP","dimensions":[{"name":"AUDIO_FILE","sample_values":["audiofile24.mp3","audiofile1.mp3","audiofile21.mp3"]},{"name":"AUDIOFILE_RELATIVE_PATH","sample_values":["audio_files/2024-11-11/audiofile23.mp3","audio_files/2024-11-15/audiofile21.mp3","audio_files/2024-11-11/audiofile24.mp3"]},{"name":"CALL_TO_ACTION","sample_values":["file claim","repair delay","forward bills"]},{"name":"CLAIM_NUMBER","sample_values":["CLM789012","NotFound","CLM567890"]},{"name":"CUSTOMER","sample_values":["Emily Turner","Daniel Miller","Sarah Mitchell"]},{"name":"CALL_INTENT","sample_values":["claim dispute","policy change","claim confusion"]},{"name":"ISSUE","sample_values":["parts delay at original repair shop causing extended repair timeline","confusion about claim filing process after minor accident","delayed communication on total loss claim"]},{"name":"POLICY_NUMBER","sample_values":["POL123456","POL789012","POL567890"]},{"name":"PURPOSE_OF_CALL","sample_values":["repair status inquiry","claim follow-up","claim inquiry"]},{"name":"REPRESENTATIVE","sample_values":["Zoe","Mia","Emma"]},{"name":"RESOLUTION","sample_values":["expedited settlement payment and documentation","found alternative repair shop with faster parts availability","claim filed and repair authorized with accident forgiveness applied"]},{"name":"RESPONSE_MODE","sample_values":["check mail","phone","immediate"]},{"name":"MODE_OF_UPDATE","sample_values":["email","written","phone"]},{"name":"NEXT_STEPS","sample_values":["transfer repair authorization to Johnson Honda","await repair shop call for appointment","customer to forward any bills from other insurance company"]},{"name":"CONVERSATION_SENTIMENT","sample_values":["Positive","Negative"]},{"name":"FIRST_CALL_RESOLUTION","sample_values":["Yes","No"]},{"name":"CONVERSATION_SUMMARY","sample_values":["Customer Daniel Miller expressed frustration over delays in getting his car repaired after an accident, as the estimated parts order was delayed. Representative Emma checked the issue and found a backorder for a specific part at Honda. She suggested switching to a Honda dealership for priority access to parts, and the customer agreed. Emma transferred the authorization to the new shop and ensured priority follow-up. The customer appreciated the solution instead of further delay.","Zoe, a representative from Auto Assure Insurance, spoke with customer Emily Turner about her delayed claim. Emily expressed frustration due to lack of communication regarding her claim status and impending deductible payment. Zoe looked up Emily''s file and found that the adjuster had completed the evaluation, but communication had been delayed. The total loss evaluation valued Emily''s car at $16,800, with a loan balance of $11,200, leaving a settlement check of $5,600 for Emily. Emily requested a settlement letter to show the dealer for a car purchase over the weekend, and Zoe promised to expedite the process and have a supervisor call her personally. Emily expressed gratitude for Zoe''s help.","Emily had a car accident and received conflicting information about her insurance coverage. Mia, from Auto Assure Insurance, helped clarify the situation. The accident was covered under Emily''s collision coverage with a $500 deductible. Emily could take her car to Jensen''s Auto Body for repair, and the claim had been opened with the authorization for Jensen''s to do the repair. Emily''s accident forgiveness meant her rates would not be affected."]}],"facts":[{"name":"TRANSCRIPTION_DURATION_SECONDS","sample_values":["149.08081","134.5045","157.49225"]}],"metrics":[{"name":"total_calls"},{"name":"total_call_time"},{"name":"first_call_resolution_rate"},{"name":"average_call_duration"}],"time_dimensions":[{"name":"DATE","sample_values":["2024-11-11","2025-01-25","2024-11-15"]}]}],"verified_queries":[{"name":"Which representatives have the highest first call resolution rate?","question":"Which representatives have the highest first call resolution rate?","sql":"SELECT\\n    REPRESENTATIVE,\\n    round(\\n        (\\n            sum(\\n                CASE\\n                    WHEN FIRST_CALL_RESOLUTION = ''Yes'' THEN 1\\n                    ELSE 0\\n                END\\n            ) * 100.0 / count(*)\\n        ),\\n        2\\n    ) as fcr_rate_percent\\nFROM\\n    ANALYZED_TRANSCRIPTIONS_APP\\nGROUP BY\\n    REPRESENTATIVE\\nORDER BY\\n    fcr_rate_percent DESC;","use_as_onboarding_question":false,"verified_by":"Michael Gorkow","verified_at":1755133007},{"name":"What is the average call duration for each representative?","question":"What is the average call duration for each representative?","sql":"SELECT\\n    REPRESENTATIVE,\\n    avg(TRANSCRIPTION_DURATION_SECONDS) as avg_duration\\nFROM\\n    ANALYZED_TRANSCRIPTIONS_APP\\nGROUP BY\\n    REPRESENTATIVE\\nORDER BY\\n    avg_duration DESC","use_as_onboarding_question":false,"verified_by":"Michael Gorkow","verified_at":1755132807},{"name":"How many calls were not resolved on the first attempt?","question":"How many calls were not resolved on the first attempt?","sql":"SELECT\\n    count(*) as calls_needing_followup,\\n    round(\\n        (\\n            count(*) * 100.0 / (\\n                select\\n                    count(*)\\n                from\\n                    ANALYZED_TRANSCRIPTIONS_APP\\n            )\\n        ),\\n        2\\n    ) as percentage_of_total\\nFROM\\n    ANALYZED_TRANSCRIPTIONS_APP\\nWHERE\\n    FIRST_CALL_RESOLUTION = ''No''","use_as_onboarding_question":false,"verified_by":"Michael Gorkow","verified_at":1755133072},{"name":"What are the most common issues customers call about?","question":"What are the most common issues customers call about?","sql":"SELECT\\n    ISSUE,\\n    count(*) as call_count\\nFROM\\n    ANALYZED_TRANSCRIPTIONS_APP\\nWHERE\\n    ISSUE is not null\\nGROUP BY\\n    ISSUE\\nORDER BY\\n    call_count DESC\\nLIMIT\\n    10","use_as_onboarding_question":false,"verified_by":"Michael Gorkow","verified_at":1755133122},{"name":"What is the sentiment breakdown by issue type?","question":"What is the sentiment breakdown by issue type?","sql":"SELECT\\n    ISSUE,\\n    CONVERSATION_SENTIMENT,\\n    count(*) as call_count\\nFROM\\n    ANALYZED_TRANSCRIPTIONS_APP\\nWHERE\\n    ISSUE IS NOT NULL\\n    AND CONVERSATION_SENTIMENT IS NOT NULL\\nGROUP BY\\n    ISSUE,\\n    CONVERSATION_SENTIMENT\\nORDER BY\\n    ISSUE,\\n    CONVERSATION_SENTIMENT\\nLIMIT\\n    10","use_as_onboarding_question":false,"verified_by":"Michael Gorkow","verified_at":1755132917}],"custom_instructions":"When analyzing call center data, prioritize customer satisfaction metrics and operational efficiency. Always consider both the customer perspective (sentiment, resolution) and business perspective (duration, volume). For date-based queries, default to the most recent complete month found in the table unless otherwise specified. For date-based queries if users is asking for last month then check what is the max month in the table as the current month and perform date subtraction to get the last month. When discussing representatives, focus on performance metrics like FCR rate and customer satisfaction. For sentiment analysis, consider the context of the issue type and resolution outcome. Ensure that all numeric columns are rounded to 2 decimal points in the output."}');